<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparateur de Documents Avancé</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <!-- CodeMirror Addons CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/dialog/dialog.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/search/matchesonscrollbar.css">

    <!-- CodeMirror Themes (Expanded Selection) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/3024-day.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/3024-night.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/abcdef.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/ambiance.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/ayu-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/ayu-mirage.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/base16-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/base16-light.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/bespin.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/blackboard.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/cobalt.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/colorforth.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/duotone-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/duotone-light.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/eclipse.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/elegant.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/erlang-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/gruvbox-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/hopscotch.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/icecoder.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/idea.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/isotope.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/lesser-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/liquibyte.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/lucario.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/material-ocean.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/material-palenight.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/material.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/mbo.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/mdn-like.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/midnight.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/moxer.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/neat.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/neo.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/night.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/nord.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/oceanic-next.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/panda-syntax.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/paraiso-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/paraiso-light.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/pastel-on-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/railscasts.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/rubyblue.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/seti.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/shadowfox.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/solarized.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/ssms.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/the-matrix.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/tomorrow-night-bright.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/tomorrow-night-eighties.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/ttcn.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/twilight.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/vibrant-ink.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/xq-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/xq-light.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/yeti.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/yonce.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/zenburn.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/one-dark.min.css">


    <style>
        :root {
            --header-height: 60px;
            --editor-container-padding-x: 1.5rem; /* px-6 for wider layout */
            --editor-container-padding-y: 0.75rem; /* py-3 */
            --editor-gap: 1rem; /* gap-4 between editors */

            --primary-color: #2563eb; /* blue-600 */
            --primary-hover-color: #1d4ed8; /* blue-700 */
            --primary-active-color: #1e40af; /* blue-800 */
            
            --secondary-color: #4b5563; /* gray-600 */
            --secondary-hover-color: #374151; /* gray-700 */

            --bg-main: #f9fafb; /* gray-50 */
            --text-main: #1f2937; /* gray-800 */
            --border-main: #e5e7eb; /* gray-200 */
            --input-bg: #ffffff; /* white */
            --card-bg: #ffffff;

            /* CodeMirror line height settings */
            --cm-font-size: 13px;
            --cm-line-height-multiplier: 1.5;
            --cm-max-lines: 100;
            --cm-max-height-calculated: calc(var(--cm-max-lines) * var(--cm-font-size) * var(--cm-line-height-multiplier));
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .CodeMirror {
            height: 100% !important;
            max-height: var(--cm-max-height-calculated);
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid var(--border-main);
            font-size: var(--cm-font-size);
            line-height: var(--cm-line-height-multiplier);
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.07), 0 1px 2px 0 rgba(0,0,0,0.05);
        }
        .CodeMirror-scroll { min-height: 200px; }

        .app-header {
            height: var(--header-height);
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-main);
            padding: 0 var(--editor-container-padding-x);
            flex-shrink: 0;
            box-shadow: 0 2px 4px -1px rgba(0,0,0,0.06), 0 4px 5px 0 rgba(0,0,0,0.04);
        }

        /* New Button Styling */
        .btn {
            @apply px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 ease-in-out flex items-center justify-center gap-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2;
            border: 1px solid transparent;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
        }
        .btn-primary:hover { background-color: var(--primary-hover-color); box-shadow: 0 2px 4px -1px rgba(0,0,0,0.06), 0 4px 5px 0 rgba(0,0,0,0.04); }
        .btn-primary:active { background-color: var(--primary-active-color); }
        .btn-primary.active { /* For toggle buttons like Sync */
            background-color: #16a34a; /* green-600 */
        }
        .btn-primary.active:hover { background-color: #15803d; }


        .btn-secondary {
            background-color: var(--input-bg);
            color: var(--secondary-color);
            border-color: var(--border-main);
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.03);
        }
        .btn-secondary:hover {
            border-color: var(--secondary-color);
            color: var(--primary-color);
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.07), 0 1px 2px 0 rgba(0,0,0,0.05);
        }
         .btn-secondary:active { background-color: #f3f4f6; /* gray-100 */ }
        .btn-secondary.active { /* For toggle buttons like Compare when active */
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .btn-icon { @apply p-2; }

        .input-field {
            @apply px-3 py-1.5 border rounded-md text-sm shadow-sm transition-colors;
            background-color: var(--input-bg);
            border-color: var(--border-main);
            color: var(--text-main);
        }
        .input-field:focus {
            @apply ring-2 ring-offset-0 ring-blue-500 border-blue-500 outline-none;
        }

        .modal-backdrop { @apply fixed inset-0 bg-black bg-opacity-40 z-40; }
        .modal {
            @apply fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 p-6 rounded-lg shadow-xl z-50 w-full max-w-md;
            background-color: var(--card-bg);
        }
        .modal-title { @apply text-lg font-semibold mb-4; }
        .modal-body { @apply text-sm mb-5; }
        .modal-footer { @apply flex justify-end gap-3; }

        /* Enhanced Dropdown Styling */
        .dropdown { @apply relative inline-block text-left; }
        .dropdown-menu {
            @apply origin-top-right absolute right-0 mt-2 w-64 rounded-md shadow-2xl ring-1 ring-black ring-opacity-5 focus:outline-none z-20;
            background-color: var(--card-bg);
            max-height: 320px; /* Increased height */
            overflow-y: auto;
            padding: 0.5rem 0; /* py-2 */
        }
        .dropdown-item {
            @apply block px-4 py-2 text-sm cursor-pointer transition-colors duration-150;
            color: var(--text-main);
        }
        .dropdown-item:hover {
            background-color: #eff6ff; /* blue-50 */
            color: var(--primary-color);
        }
        .dropdown-item.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
        }


        #tIcon {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            width: 36px; height: 36px; /* Slightly larger */
        }

        #editorContainer {
            flex-grow: 1;
            width: 100%;
            max-width: 1600px; /* Max width for very large screens */
            margin-left: auto;
            margin-right: auto;
            display: flex;
            padding: var(--editor-container-padding-y) var(--editor-container-padding-x);
            gap: var(--editor-gap);
            box-sizing: border-box;
        }
        .editor-wrapper {
            display: flex;
            flex-direction: column;
            min-height: 0;
            flex-basis: 0;
            flex-grow: 1;
        }
        .editor-wrapper > div.flex-grow {
             flex-grow: 1;
             min-height: 0;
             position: relative;
             display: flex;
        }
        .editor-wrapper > div.flex-grow > .CodeMirror {
            flex-grow: 1;
        }

        .drop-overlay {
            @apply absolute inset-0 bg-gray-800 bg-opacity-75 flex justify-center items-center text-white text-xl rounded-lg pointer-events-none opacity-0 transition-opacity duration-300 z-10;
        }
        .drop-overlay.active { @apply opacity-100 pointer-events-auto; }

        .identical-line {
            background-color: rgba(74, 222, 128, 0.2); /* Tailwind green-400 with opacity */
        }
        /* Remove old diff styles if not used by other features */
        /* .diff-line { ... } */
        /* .diff-char { ... } */


        .CodeMirror-matchingtag { background: rgba(59, 130, 246, .25); }
        .CodeMirror-focused .cm-matchhighlight { background-color: rgba(59, 130, 246, 0.25); }
        .cm-matchhighlight { background-color: rgba(59, 130, 246, 0.2); }
        .CodeMirror-selection-highlight-scrollbar { background-color: rgba(59, 130, 246, 0.35); }

        .search-results-count { @apply text-xs ml-1.5 opacity-75; }

        .CodeMirror-dialog {
            background-color: var(--card-bg) !important;
            color: var(--text-main) !important;
            border: 1px solid var(--border-main) !important;
            @apply rounded-lg shadow-xl text-sm p-4;
        }
        .CodeMirror-dialog input[type="text"] {
             @apply input-field !important;
             padding: 0.5rem 0.75rem !important; /* py-2 px-3 */
        }
        .CodeMirror-dialog button {
            @apply btn btn-secondary !important;
            padding: 0.375rem 0.75rem !important; /* py-1.5 px-3 */
            font-size: 0.875rem !important; /* text-sm */
        }
        .CodeMirror-search-label {
             color: var(--text-main) !important;
             @apply text-sm mb-1;
        }
    </style>
</head>
<body class="antialiased">
    <!-- Header -->
    <header class="app-header flex items-center justify-between fixed top-0 left-0 right-0 z-30">
        <div class="flex items-center gap-3">
            <button id="tIcon" class="btn btn-secondary btn-icon" title="Portail T">T</button>
            <h1 class="text-lg font-semibold">Comparateur de Documents</h1>
        </div>

        <div class="flex items-center gap-2.5 flex-wrap justify-end">
            <div class="flex items-center">
                <input type="number" id="goToLineInput" placeholder="Ligne" class="input-field w-24 text-sm" min="1">
                <button id="goToLineBtn" class="btn btn-secondary btn-icon ml-1.5" title="Aller à la ligne">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6.293 3.293a1 1 0 011.414 0l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414-1.414L10.586 10 6.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            </div>

            <div class="flex items-center">
                <input type="text" id="searchInput" placeholder="Rechercher..." class="input-field w-40 text-sm">
                <button id="searchBtn" class="btn btn-secondary btn-icon ml-1.5" title="Rechercher (Ctrl+F)">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
                </button>
                <button id="replaceBtn" class="btn btn-secondary btn-icon ml-1.5" title="Remplacer (Ctrl+H)">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M5 8a1 1 0 00-1 1v1a1 1 0 102 0V9a1 1 0 00-1-1z"></path><path fill-rule="evenodd" d="M6.672 1.953A1 1 0 017.999 2h4a1 1 0 011 1v1H7.999a1 1 0 01-.895-.553L6.672 1.953zM4.001 4V3a1 1 0 011-1h1.328l.447-.553a3 3 0 012.624 0l.447.553H14a1 1 0 011 1v1H4.001zm11.999 7h-12v1a3 3 0 003 3h6a3 3 0 003-3v-1zM4 6h12v4a1 1 0 01-1 1H5a1 1 0 01-1-1V6z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <span id="searchOccurrencesTotal" class="text-xs opacity-75 hidden self-center"></span>

            <button id="syncScrollBtn" class="btn btn-secondary" title="Synchroniser le défilement">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm0 0c5.523 0 10 4.477 10 10s-4.477 10-10 10S0 15.523 0 10 4.477 0 10 0zm-7 9a1 1 0 011-1h4a1 1 0 110 2H4a1 1 0 01-1-1zm14 0a1 1 0 011-1h4a1 1 0 110 2h-4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                Sync
            </button>
            <button id="compareBtn" class="btn btn-secondary" title="Comparer les documents">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-2V3a1 1 0 10-2 0v1H9V3a1 1 0 00-1-1H7zm1 4a1 1 0 100 2h4a1 1 0 100-2H8z" clip-rule="evenodd"></path></svg>
                Comparer
            </button>

            <div class="dropdown">
                <button id="themeToggleBtn" class="btn btn-secondary" title="Changer de thème">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z"></path></svg>
                    Thèmes
                </button>
                <div id="themeDropdown" class="dropdown-menu hidden"></div>
            </div>
        </div>
    </header>

    <main id="editorContainer" class="flex-grow">
        <section id="editor1Wrapper" class="relative flex-1 flex flex-col editor-wrapper">
            <h2 class="text-sm font-semibold mb-2 opacity-90">Document 1 <span id="occurrences1" class="search-results-count"></span></h2>
            <div class="flex-grow relative"><textarea id="code1"></textarea><div class="drop-overlay" id="drop-overlay-1"><p>Déposez le fichier ici</p></div></div>
        </section>

        <section id="editor2Wrapper" class="relative flex-1 flex flex-col editor-wrapper">
            <h2 class="text-sm font-semibold mb-2 opacity-90">Document 2 <span id="occurrences2" class="search-results-count"></span></h2>
            <div class="flex-grow relative"><textarea id="code2"></textarea><div class="drop-overlay" id="drop-overlay-2"><p>Déposez le fichier ici</p></div></div>
        </section>
    </main>

    <div id="tPortalModalBackdrop" class="modal-backdrop hidden"></div>
    <div id="tPortalModal" class="modal hidden">
        <h3 class="modal-title">Portail T</h3>
        <div class="modal-body">Souhaitez-vous revenir au portail T ?</div>
        <div class="modal-footer">
            <button id="closeTPortalModalBtn" class="btn btn-secondary">Annuler</button>
            <a href="https://Terrafaust.github.io/T" target="_blank" class="btn btn-primary">Retourner au portail</a>
        </div>
    </div>

    <div id="messageBoxBackdrop" class="modal-backdrop hidden"></div>
    <div id="messageBox" class="modal hidden">
        <p id="messageBoxText" class="modal-body"></p>
        <div class="modal-footer"><button id="messageBoxCloseBtn" class="btn btn-primary">Fermer</button></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/meta.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/scroll/scrollpastend.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/selection/active-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/edit/matchbrackets.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/search/searchcursor.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/search/search.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/dialog/dialog.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/search/jump-to-line.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/search/matchesonscrollbar.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/search/match-highlighter.js"></script>

    <script>
        let editor1, editor2;
        let syncScroll = false;
        let activeMarks = []; // Renamed from diffMarks for clarity
        let currentTheme = 'one-dark';

        const availableThemes = [
            // Dark Themes
            { name: 'One Dark', value: 'one-dark' }, { name: 'Dracula', value: 'dracula' },
            { name: 'Material Palenight', value: 'material-palenight' }, { name: 'Material Darker', value: 'material-darker' },
            { name: 'Material Ocean', value: 'material-ocean' }, { name: 'Monokai', value: 'monokai' },
            { name: 'Nord', value: 'nord' }, { name: 'Cobalt', value: 'cobalt' },
            { name: 'Ayu Dark', value: 'ayu-dark' }, { name: 'Ayu Mirage', value: 'ayu-mirage' },
            { name: 'Base16 Dark', value: 'base16-dark' }, { name: 'Bespin', value: 'bespin' },
            { name: 'Blackboard', value: 'blackboard' }, { name: 'Duotone Dark', value: 'duotone-dark' },
            { name: 'Erling Dark', value: 'erlang-dark' }, { name: 'Gruvbox Dark', value: 'gruvbox-dark' },
            { name: 'Lesser Dark', value: 'lesser-dark' }, { name: 'Liquibyte', value: 'liquibyte' },
            { name: 'Lucario', value: 'lucario' }, { name: 'Midnight', value: 'midnight' },
            { name: 'Moxer', value: 'moxer' }, { name: 'Night', value: 'night' },
            { name: 'Oceanic Next', value: 'oceanic-next' }, { name: 'Panda Syntax', value: 'panda-syntax' },
            { name: 'Paraiso Dark', value: 'paraiso-dark' }, { name: 'Pastel on Dark', value: 'pastel-on-dark' },
            { name: 'Railscasts', value: 'railscasts' }, { name: 'Rubyblue', value: 'rubyblue' },
            { name: 'Seti', value: 'seti' }, { name: 'Shadowfox', value: 'shadowfox' },
            { name: 'Solarized Dark', value: 'solarized dark' }, { name: 'SSMS', value: 'ssms' },
            { name: 'The Matrix', value: 'the-matrix' }, { name: 'Tomorrow Night Bright', value: 'tomorrow-night-bright' },
            { name: 'Tomorrow Night Eighties', value: 'tomorrow-night-eighties' }, { name: 'Twilight', value: 'twilight' },
            { name: 'Vibrant Ink', value: 'vibrant-ink' }, { name: 'XQ Dark', value: 'xq-dark' },
            { name: 'Yonce', value: 'yonce' }, { name: 'Zenburn', value: 'zenburn' },
            // Light Themes
            { name: 'Eclipse', value: 'eclipse' }, { name: 'Material Light', value: 'material' }, // Renamed from 'material' for clarity
            { name: 'Solarized Light', value: 'solarized light' }, { name: '3024 Day', value: '3024-day' },
            { name: 'Abcdef', value: 'abcdef' }, { name: 'Ambiance (Light)', value: 'ambiance' }, // Ambiance is often dark, but CM provides a light one too
            { name: 'Base16 Light', value: 'base16-light' }, { name: 'Colorforth', value: 'colorforth' },
            { name: 'Duotone Light', value: 'duotone-light' }, { name: 'Elegant', value: 'elegant' },
            { name: 'Hopscotch', value: 'hopscotch' }, { name: 'Icecoder', value: 'icecoder' },
            { name: 'Idea', value: 'idea' }, { name: 'Isotope', value: 'isotope' },
            { name: 'MDN Like', value: 'mdn-like' }, { name: 'Neat', value: 'neat' },
            { name: 'Neo', value: 'neo' }, { name: 'Paraiso Light', value: 'paraiso-light' },
            { name: 'TTCN', value: 'ttcn' }, { name: 'XQ Light', value: 'xq-light' },
            { name: 'Yeti', value: 'yeti' }, { name: 'CodeMirror Default', value: 'default' }
        ];


        function showMessageBox(message) {
            document.getElementById('messageBoxText').textContent = message;
            document.getElementById('messageBox').classList.remove('hidden');
            document.getElementById('messageBoxBackdrop').classList.remove('hidden');
        }

        function hideMessageBox() {
            document.getElementById('messageBox').classList.add('hidden');
            document.getElementById('messageBoxBackdrop').classList.add('hidden');
        }

        function getModeForFile(filename) {
            const info = CodeMirror.findModeByExtension(filename.split('.').pop());
            return info ? info.mode : 'text/plain';
        }

        window.onload = function() {
            const commonOptions = {
                lineNumbers: true,
                theme: currentTheme,
                lineWrapping: true,
                styleActiveLine: true,
                matchBrackets: true,
                scrollPastEnd: true,
                highlightSelectionMatches: { showToken: /\w/, annotateScrollbar: true },
            };

            editor1 = CodeMirror.fromTextArea(document.getElementById('code1'), commonOptions);
            editor2 = CodeMirror.fromTextArea(document.getElementById('code2'), commonOptions);

            editor1.setValue(`// Document 1 - Exemple de code\nfunction helloWorld(name) {\n  // Une ligne identique.\n  console.log("Bonjour, " + name + "!"); // Commentaire différent\n  return name.toUpperCase();\n}\n\nconst user = "Utilisateur";\nhelloWorld(user);\n// Fin du document 1.`);
            editor2.setValue(`// Document 2 - Exemple de code\nfunction helloWorld(name) {\n  // Une ligne identique.\n  console.log("Hello, " + name + "!"); // Different comment\n  return name.toLowerCase();\n}\n\nconst user = "Utilisateur";\nhelloWorld(user);\n// Fin du document 2.`);
            
            // Populate theme dropdown after editors are initialized
            setupThemeSwitcher();
            // Then other setups
            setupDragAndDrop();
            setupScrollSynchronization();
            setupComparison();
            setupGoToLine();
            setupSearchAndReplace();
            setupTPortalModal();

            document.getElementById('messageBoxCloseBtn').addEventListener('click', hideMessageBox);
            
            // Set initial theme and refresh
            setTheme(currentTheme); // Apply initial theme to mark it active in dropdown
            setTimeout(() => { editor1.refresh(); editor2.refresh(); }, 100);
        };
        
        window.onresize = function() {
            if (editor1) editor1.refresh();
            if (editor2) editor2.refresh();
        };

        function setupDragAndDrop() {
            ['editor1Wrapper', 'editor2Wrapper'].forEach((id, index) => {
                const section = document.getElementById(id);
                const overlay = document.getElementById(`drop-overlay-${index + 1}`);
                const editorInstance = index === 0 ? editor1 : editor2;

                section.addEventListener('dragover', (e) => { e.preventDefault(); overlay.classList.add('active'); });
                section.addEventListener('dragleave', (e) => { if (e.target === section || !section.contains(e.relatedTarget)) overlay.classList.remove('active');});
                section.addEventListener('drop', (e) => {
                    e.preventDefault();
                    overlay.classList.remove('active');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            editorInstance.setValue(event.target.result);
                            editorInstance.setOption('mode', getModeForFile(file.name));
                            showMessageBox(`Fichier "${file.name}" chargé.`);
                            clearActiveMarks();
                            const compareBtn = document.getElementById('compareBtn');
                            compareBtn.innerHTML = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-2V3a1 1 0 10-2 0v1H9V3a1 1 0 00-1-1H7zm1 4a1 1 0 100 2h4a1 1 0 100-2H8z" clip-rule="evenodd"></path></svg> Comparer`;
                            compareBtn.classList.remove('active','btn-primary');
                            compareBtn.classList.add('btn-secondary');
                        };
                        reader.onerror = () => showMessageBox(`Erreur lecture fichier "${file.name}".`);
                        reader.readAsText(file);
                    }
                });
            });
        }

        function setupScrollSynchronization() {
            const syncScrollBtn = document.getElementById('syncScrollBtn');
            let isSyncing = false;

            function syncEditorScroll(sourceEditor, targetEditor) {
                if (isSyncing) return;
                isSyncing = true;
                const scrollInfo = sourceEditor.getScrollInfo();
                if (scrollInfo.clientHeight > 0 && (scrollInfo.height - scrollInfo.clientHeight) > 0) {
                    const scrollPercentage = scrollInfo.top / (scrollInfo.height - scrollInfo.clientHeight);
                     if (!isNaN(scrollPercentage) && targetEditor.getScrollInfo().height > targetEditor.getScrollInfo().clientHeight) {
                         targetEditor.scrollTo(null, scrollPercentage * (targetEditor.getScrollInfo().height - targetEditor.getScrollInfo().clientHeight));
                    }
                } else if (scrollInfo.clientHeight > 0 && scrollInfo.top === 0 && (scrollInfo.height - scrollInfo.clientHeight) <= 0) {
                    targetEditor.scrollTo(null, 0);
                }
                setTimeout(() => isSyncing = false, 30);
            }

            const onScroll1 = () => { if (syncScroll) syncEditorScroll(editor1, editor2); };
            const onScroll2 = () => { if (syncScroll) syncEditorScroll(editor2, editor1); };

            syncScrollBtn.addEventListener('click', () => {
                syncScroll = !syncScroll;
                syncScrollBtn.classList.toggle('active', syncScroll);
                syncScrollBtn.classList.toggle('btn-primary', syncScroll);
                syncScrollBtn.classList.toggle('btn-secondary', !syncScroll);
                syncScrollBtn.title = syncScroll ? "Désynchroniser" : "Synchroniser";
                if (syncScroll) {
                    showMessageBox('Défilement synchronisé.');
                    editor1.on('scroll', onScroll1);
                    editor2.on('scroll', onScroll2);
                    syncEditorScroll(editor1, editor2);
                } else {
                    showMessageBox('Défilement désynchronisé.');
                    editor1.off('scroll', onScroll1);
                    editor2.off('scroll', onScroll2);
                }
            });
        }

        function setupComparison() {
            const compareBtn = document.getElementById('compareBtn');
            compareBtn.addEventListener('click', () => {
                if (activeMarks.length > 0) { // If marks exist, clear them
                    clearActiveMarks();
                    compareBtn.innerHTML = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-2V3a1 1 0 10-2 0v1H9V3a1 1 0 00-1-1H7zm1 4a1 1 0 100 2h4a1 1 0 100-2H8z" clip-rule="evenodd"></path></svg> Comparer`;
                    compareBtn.classList.remove('active', 'btn-primary');
                    compareBtn.classList.add('btn-secondary');
                    showMessageBox('Surlignage des lignes identiques effacé.');
                    return;
                }

                // Perform new comparison for identical lines
                const doc1Lines = editor1.getValue().split('\n');
                const doc2Lines = editor2.getValue().split('\n');
                const maxLines = Math.max(doc1Lines.length, doc2Lines.length);
                let identicalLinesFound = 0;

                for (let i = 0; i < maxLines; i++) {
                    const line1 = doc1Lines[i]; // Can be undefined if one doc is shorter
                    const line2 = doc2Lines[i]; // Can be undefined

                    if (line1 !== undefined && line2 !== undefined && line1 === line2) {
                        identicalLinesFound++;
                        if (line1.trim().length > 0) { // Only mark non-empty identical lines
                           activeMarks.push(editor1.markText({line:i,ch:0}, {line:i,ch:line1.length}, {className:'identical-line'}));
                           activeMarks.push(editor2.markText({line:i,ch:0}, {line:i,ch:line2.length}, {className:'identical-line'}));
                        }
                    }
                }

                if (identicalLinesFound > 0) {
                    showMessageBox(`${identicalLinesFound} ligne(s) identique(s) trouvée(s) et surlignée(s).`);
                    compareBtn.innerHTML = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg> Effacer`;
                    compareBtn.classList.add('active', 'btn-primary');
                    compareBtn.classList.remove('btn-secondary');
                } else {
                    showMessageBox('Aucune ligne strictement identique trouvée.');
                }
            });
        }
        function clearActiveMarks() {
            activeMarks.forEach(mark => mark.clear());
            activeMarks = [];
        }

        function setupGoToLine() {
            const goToLineInput = document.getElementById('goToLineInput');
            const goToLineBtn = document.getElementById('goToLineBtn');
            function doGoToLine() {
                const lineNum = parseInt(goToLineInput.value, 10);
                if (isNaN(lineNum) || lineNum <= 0) { showMessageBox("Numéro de ligne invalide."); return; }
                [editor1, editor2].forEach(editor => {
                    if (lineNum <= editor.lineCount()) {
                        editor.setCursor(lineNum - 1, 0);
                        const coords = editor.charCoords({line: lineNum - 1, ch: 0}, "local");
                        const H = editor.getScrollInfo().clientHeight;
                        const Y = coords.top;
                        editor.scrollTo(null, Y - (H / 3));
                        editor.focus();
                    }
                });
                goToLineInput.value = '';
            }
            goToLineBtn.addEventListener('click', doGoToLine);
            goToLineInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') doGoToLine(); });
        }

        function setupSearchAndReplace() {
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const replaceBtn = document.getElementById('replaceBtn');
            const occurrencesTotalSpan = document.getElementById('searchOccurrencesTotal');
            const occurrences1Span = document.getElementById('occurrences1');
            const occurrences2Span = document.getElementById('occurrences2');

            function performSearchInEditor(editor, query, caseSensitive, occurrencesEl) {
                if (!query) {
                    if (editor.state.matchHighlighter) { editor.state.matchHighlighter.clear(); }
                    occurrencesEl.textContent = '';
                    return 0;
                }
                let count = 0;
                const cursor = editor.getSearchCursor(query, null, { caseFold: !caseSensitive, multiline: true });
                while(cursor.findNext()) { count++; }
                
                if (query) {
                    editor.setOption("highlightSelectionMatches", {
                        showToken: new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), caseSensitive ? '' : 'i'),
                        annotateScrollbar: true
                    });
                } else {
                     editor.setOption("highlightSelectionMatches", false);
                }
                
                occurrencesEl.textContent = count > 0 ? `(${count})` : '';
                return count;
            }
            
            function updateGlobalOccurrenceCount() {
                const query = searchInput.value;
                const caseSensitive = false; 
                const count1 = performSearchInEditor(editor1, query, caseSensitive, occurrences1Span);
                const count2 = performSearchInEditor(editor2, query, caseSensitive, occurrences2Span);
                const total = count1 + count2;
                if (query && total > 0) {
                    occurrencesTotalSpan.textContent = `${total} au total`;
                    occurrencesTotalSpan.classList.remove('hidden');
                } else {
                    occurrencesTotalSpan.classList.add('hidden');
                    if (!query) {
                        occurrences1Span.textContent = '';
                        occurrences2Span.textContent = '';
                    }
                }
            }

            searchInput.addEventListener('input', updateGlobalOccurrenceCount);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const activeEditor = editor1.hasFocus() ? editor1 : editor2;
                    CodeMirror.commands.findNext(activeEditor);
                }
            });

            searchBtn.addEventListener('click', () => {
                const activeEditor = editor1.hasFocus() ? editor1 : (editor2.hasFocus() ? editor2 : editor1);
                CodeMirror.commands.find(activeEditor, searchInput.value || undefined);
            });

            replaceBtn.addEventListener('click', () => {
                const activeEditor = editor1.hasFocus() ? editor1 : (editor2.hasFocus() ? editor2 : editor1);
                CodeMirror.commands.replace(activeEditor, searchInput.value || undefined);
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && (e.key === 'f' || e.key === 'F')) {
                    e.preventDefault();
                    searchInput.focus(); searchInput.select();
                    searchBtn.click();
                }
                if (e.ctrlKey && (e.key === 'h' || e.key === 'H')) {
                    e.preventDefault();
                    searchInput.focus(); searchInput.select();
                    replaceBtn.click();
                }
            });
        }

        function setupThemeSwitcher() {
            const themeBtn = document.getElementById('themeToggleBtn');
            const dropdown = document.getElementById('themeDropdown');
            dropdown.innerHTML = ''; // Clear previous items

            availableThemes.forEach(theme => {
                const item = document.createElement('a');
                item.className = 'dropdown-item';
                item.textContent = theme.name;
                if (theme.value === currentTheme) {
                    item.classList.add('active');
                }
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    setTheme(theme.value);
                    // Update active class in dropdown
                    Array.from(dropdown.children).forEach(child => child.classList.remove('active'));
                    item.classList.add('active');
                    dropdown.classList.add('hidden');
                });
                dropdown.appendChild(item);
            });
            themeBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent click from immediately closing via document listener
                dropdown.classList.toggle('hidden');
            });
        }

        function setTheme(themeValue) {
            currentTheme = themeValue;
            [editor1, editor2].forEach(editor => editor.setOption('theme', themeValue));
            
            // Update active class in dropdown if it's already populated
            const dropdown = document.getElementById('themeDropdown');
            if (dropdown.children.length > 0) {
                 Array.from(dropdown.children).forEach(child => {
                    child.classList.toggle('active', child.textContent === availableThemes.find(t => t.value === themeValue)?.name);
                });
            }
        }
        
        // Close dropdown if clicked outside
        document.addEventListener('click', (event) => {
            const themeBtn = document.getElementById('themeToggleBtn');
            const dropdown = document.getElementById('themeDropdown');
            if (dropdown && !dropdown.classList.contains('hidden') && !themeBtn.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });


        function setupTPortalModal() {
            const tIcon = document.getElementById('tIcon');
            const modal = document.getElementById('tPortalModal');
            const backdrop = document.getElementById('tPortalModalBackdrop');
            const closeModalBtn = document.getElementById('closeTPortalModalBtn');
            tIcon.addEventListener('click', () => { modal.classList.remove('hidden'); backdrop.classList.remove('hidden'); });
            function close() { modal.classList.add('hidden'); backdrop.classList.add('hidden'); }
            closeModalBtn.addEventListener('click', close);
            backdrop.addEventListener('click', close);
        }
    </script>
</body>
</html>
